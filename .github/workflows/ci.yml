name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # ── Linux Receiver (Rust) ──────────────────────────────────────────────
  linux-receiver:
    name: Linux Receiver
    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@v4

      - name: Install GStreamer dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            libgstreamer1.0-dev \
            libgstreamer-plugins-base1.0-dev \
            libgstreamer-plugins-bad1.0-dev \
            gstreamer1.0-plugins-base \
            gstreamer1.0-plugins-good \
            gstreamer1.0-plugins-bad \
            gstreamer1.0-plugins-ugly \
            gstreamer1.0-libav \
            libavcodec-dev \
            pkg-config

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache Cargo registry & build
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            linux-receiver/target
          key: linux-${{ runner.os }}-cargo-${{ hashFiles('linux-receiver/Cargo.lock') }}
          restore-keys: linux-${{ runner.os }}-cargo-

      - name: cargo fmt check
        run: cargo fmt --all --check
        working-directory: linux-receiver

      - name: cargo clippy
        run: cargo clippy --release --all-targets -- -D warnings
        working-directory: linux-receiver

      - name: cargo build --release
        run: cargo build --release -p duallink-app
        working-directory: linux-receiver

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: duallink-receiver-linux-x86_64
          path: linux-receiver/target/release/duallink-receiver
          retention-days: 14

  # ── macOS Client (Swift) ──────────────────────────────────────────────
  mac-client:
    name: macOS Client
    runs-on: macos-14       # Apple Silicon runner (M1)

    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_16.app/Contents/Developer

      - name: Cache Swift build
        uses: actions/cache@v4
        with:
          path: mac-client/.build
          key: macos-swift-${{ hashFiles('mac-client/Package.resolved') }}
          restore-keys: macos-swift-

      - name: swift build
        run: swift build -c release
        working-directory: mac-client

      - name: swift test
        run: swift test
        working-directory: mac-client

  # ── macOS Receiver (Rust — Phase 5A cross-platform validation) ───────────
  macos-receiver-build:
    name: macOS Receiver Build
    runs-on: macos-14          # Apple Silicon; GStreamer available via Homebrew

    steps:
      - uses: actions/checkout@v4

      - name: Install GStreamer via Homebrew
        run: |
          brew install \
            gstreamer \
            gst-plugins-base \
            gst-plugins-good \
            gst-plugins-bad \
            gst-plugins-ugly \
            gst-libav

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo registry & build
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            linux-receiver/target
          key: macos-cargo-${{ hashFiles('linux-receiver/Cargo.lock') }}
          restore-keys: macos-cargo-

      - name: cargo build (release)
        run: cargo build --release -p duallink-app
        working-directory: linux-receiver
        env:
          PKG_CONFIG_PATH: /opt/homebrew/lib/pkgconfig

  # ── Windows Receiver (Rust — Phase 5B.3: full GStreamer build) ──────────
  windows-receiver-build:
    name: Windows Receiver Build
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain (MSVC)
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Install GStreamer (MSVC, runtime + devel)
        shell: pwsh
        run: |
          $ver = "1.24.2"
          $base = "https://gstreamer.freedesktop.org/data/pkg/windows/$ver/msvc"
          Write-Host "Downloading GStreamer $ver..."
          Invoke-WebRequest "$base/gstreamer-1.0-msvc-x86_64-$ver.msi" -OutFile gst-runtime.msi
          Invoke-WebRequest "$base/gstreamer-1.0-devel-msvc-x86_64-$ver.msi" -OutFile gst-devel.msi
          Write-Host "Installing GStreamer runtime..."
          Start-Process msiexec.exe -Wait -ArgumentList "/i gst-runtime.msi /qn"
          Write-Host "Installing GStreamer devel..."
          Start-Process msiexec.exe -Wait -ArgumentList "/i gst-devel.msi /qn"
          "PKG_CONFIG_PATH=C:\gstreamer\1.0\msvc_x86_64\lib\pkgconfig" | Out-File -Append $env:GITHUB_ENV
          "C:\gstreamer\1.0\msvc_x86_64\bin" | Out-File -Append $env:GITHUB_PATH

      - name: Install pkg-config
        shell: pwsh
        run: choco install pkgconfiglite --yes

      - name: Cache Cargo registry & build
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            linux-receiver/target
          key: windows-cargo-${{ hashFiles('linux-receiver/Cargo.lock') }}
          restore-keys: windows-cargo-

      - name: Build platform-agnostic crates (always succeeds)
        run: cargo build --release -p duallink-core -p duallink-transport
        working-directory: linux-receiver

      - name: Build full receiver with GStreamer decoder
        run: cargo build --release -p duallink-app
        working-directory: linux-receiver
        # Phase 5B.3: GStreamer pkg-config detection may need tuning on CI.
        # Local Windows builds work — see windows-receiver/README.md.
        continue-on-error: true

  # ── Linux Sender (Rust — Phase 5C+: PipeWire capture + GStreamer encode)  ──
  linux-sender-build:
    name: Linux Sender Build
    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@v4

      - name: Install GStreamer dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            libgstreamer1.0-dev \
            libgstreamer-plugins-base1.0-dev \
            libgstreamer-plugins-bad1.0-dev \
            pkg-config

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo registry & build
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            linux-sender/target
          key: linux-sender-cargo-${{ hashFiles('linux-sender/Cargo.lock') }}
          restore-keys: linux-sender-cargo-

      - name: cargo build (all workspace crates)
        run: cargo build --workspace
        working-directory: linux-sender

  # ── Windows Sender (Rust — Phase 5E+: WGC capture + GStreamer + SendInput) ─
  windows-sender-build:
    name: Windows Sender Build
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain (MSVC)
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Install GStreamer MSVC via Chocolatey
        run: |
          choco install gstreamer --version=1.24.3 --yes
          choco install gstreamer-devel --version=1.24.3 --yes
        continue-on-error: true

      - name: Set GStreamer environment
        shell: pwsh
        run: |
          $gstRoot = "C:\gstreamer\1.0\msvc_x86_64"
          if (Test-Path $gstRoot) {
            echo "PKG_CONFIG_PATH=$gstRoot\lib\pkgconfig" | Out-File -Append -Encoding utf8 $env:GITHUB_ENV
            echo "$gstRoot\bin" | Out-File -Append -Encoding utf8 $env:GITHUB_PATH
          }
        continue-on-error: true

      - name: Install pkg-config
        run: choco install pkgconfiglite --yes
        continue-on-error: true

      - name: Cache Cargo registry & build
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            windows-sender/target
          key: windows-sender-cargo-${{ hashFiles('windows-sender/Cargo.lock') }}
          restore-keys: windows-sender-cargo-

      - name: cargo check duallink-core (no GStreamer needed)
        run: cargo check -p duallink-core
        working-directory: windows-sender

      - name: cargo check duallink-windows-sender (requires GStreamer)
        run: cargo check -p duallink-windows-sender
        working-directory: windows-sender
        continue-on-error: true  # GStreamer MSVC CI install may be unavailable

  # ── Release: build & upload on version tags ───────────────────────────
  release:
    name: Release
    needs: [linux-receiver, mac-client]
    runs-on: ubuntu-24.04
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - uses: actions/checkout@v4

      - name: Download Linux binary
        uses: actions/download-artifact@v4
        with:
          name: duallink-receiver-linux-x86_64
          path: dist/

      - name: Create release archive
        run: |
          chmod +x dist/duallink-receiver
          cp infra/linux/install.sh dist/
          cp infra/linux/duallink-receiver.service dist/
          tar -czf duallink-receiver-${{ github.ref_name }}-linux-x86_64.tar.gz -C dist .

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: duallink-receiver-${{ github.ref_name }}-linux-x86_64.tar.gz
          generate_release_notes: true
